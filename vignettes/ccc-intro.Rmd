---
title: "Introduction to `ccc`: Differential Cell-Cell Communication Analysis"
author: "Chenghao Wang"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Introduction to ccc}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Overview

The `ccc` package provides tools for identifying differential cell-cell communication from single-cell RNA-sequencing data. This vignette demonstrates how to use the main functions of the package to analyze cell-cell communication patterns across different conditions.

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 6,
  fig.align = "center"
)
```

```{r, message = FALSE,  warning = FALSE}
# load packages
library(ccc)
library(Rtsne)
library(ggplot2)
library(patchwork)
library(pheatmap)
library(dplyr)
library(tidyr)
```

# Differential Cell-Cell Communication Analysis

## Data simulation and exploratory data analysis

```{r}
# simulate data
data.sim1 <- sim_count(seed = 1, n_genes = 1000, sample_group = c(3, 3), 
                       cells_per_sample = rep(100, 6), avg_logfc = 1.5,
                       grp_specific_prop = 0.2, ct_specific_prop = 0.05)

# expression_matrix <- log_normalize(data.sim1$counts)
expression_matrix <- log_normalize(data.sim1$counts)
metadata <- data.sim1$metadata
gene_info <- data.sim1$gene_info
```

```{r}
metadata %>%
  count(sample, cell_type) %>%
  pivot_wider(names_from = cell_type, values_from = n, values_fill = 0)
```

```{r colors, echo = TRUE}
cell_type_colors <- c(
  "CT1" = "#1b9e77",
  "CT2" = "#d95f02",
  "CT3" = "#7570b3"
)
sample_colors <- c(
  "S1" = "#a1d99b",  
  "S2" = "#41ab5d",  
  "S3" = "#005a32",  

  "S4" = "#dadaeb",  
  "S5" = "#9e9ac8",  
  "S6" = "#54278f"  
)
group_colors <- c("grp1" = "green3", "grp2" = "purple3")
```


```{r}
set.seed(42)
tsne_out <- Rtsne(t(expression_matrix), dims = 2, perplexity = 30, pca = TRUE, pca_scale = TRUE)

tsne_df <- data.frame(
  TSNE1 = tsne_out$Y[, 1],
  TSNE2 = tsne_out$Y[, 2]
)
tsne_df$cell_type <- metadata$cell_type
tsne_df$group <- metadata$group
tsne_df$sample <- metadata$sample
```

```{r tsne_plot}
p1 <- ggplot(tsne_df, aes(x = TSNE1, y = TSNE2, color = cell_type)) +
  geom_point(alpha = 0.7) +
  theme_minimal() +
  labs(color = "Cell Type") +
  scale_color_manual(values = cell_type_colors)

p2 <- ggplot(tsne_df, aes(x = TSNE1, y = TSNE2, color = group)) +
  geom_point(alpha = 0.7) +
  theme_minimal() +
  labs(color = "Group") +
  scale_color_manual(values = group_colors)

p3 <- ggplot(tsne_df, aes(x = TSNE1, y = TSNE2, color = sample)) +
  geom_point(alpha = 0.7) +
  theme_minimal() +
  labs(color = "Sample") 

# Combine side by side
p1 + p2 + p3 + plot_layout(ncol = 2)
```

```{r}
metadata_sorted <- metadata[order(metadata$cell_type, metadata$sample), ]
expression_matrix_sorted <- expression_matrix[, metadata_sorted$cell_id]

# Subset genes that are differentially expressed across cell types or groups and have high expression mean
var_genes <- gene_info %>% 
  filter(CT1_logfc != 0 | CT2_logfc != 0 | CT3_logfc != 0 | grp2_logfc != 0) %>%
  filter(gene_id %in% rownames(expression_matrix)[rowMeans(expression_matrix) > 1.5]) %>% 
  pull(gene_id)
expression_matrix_top <- expression_matrix_sorted[var_genes, ]

rownames(metadata_sorted) <- metadata_sorted$cell_id
annotation_col <- metadata_sorted[, c("sample", "cell_type")]

annotation_colors <- list(
  cell_type = cell_type_colors,
  sample = sample_colors
)
pheatmap(expression_matrix_top,
         annotation_col = annotation_col,
         annotation_colors = annotation_colors,
         show_rownames = FALSE,
         show_colnames = FALSE,
         scale = "row",  # z-score by gene
         cluster_cols = FALSE)
```

```{r}
  # Calculate CDR for each cell
  cdr <- colMeans(expression_matrix > 0)
  
  # Perform PCA
  pca_result <- prcomp(t(expression_matrix), center = TRUE, scale. = TRUE)
  
  # Calculate proportion of variance explained
  var_explained <- pca_result$sdev^2 / sum(pca_result$sdev^2)
  pc1_var <- round(var_explained[1] * 100, 1)
  pc2_var <- round(var_explained[2] * 100, 1)
  
  # Create data frame with PCA results and metadata
  pca_df <- data.frame(
    PC1 = pca_result$x[, 1],
    PC2 = pca_result$x[, 2],
    CDR = cdr,
    cell_type = metadata$cell_type,
    group = metadata$group,
    sample = metadata$sample
  )
  
  # Create plots with different colorings
  # PC1 vs CDR
  p1 <- ggplot(pca_df, aes(x = PC1, y = CDR, color = cell_type)) +
    geom_point(alpha = 0.7) +
    theme_minimal() +
    labs(title = "PC1 vs CDR", 
         x = paste0("PC1 (", pc1_var, "%)"),
         color = "Cell Type") +
    scale_color_manual(values = cell_type_colors)
  
  p2 <- ggplot(pca_df, aes(x = PC1, y = CDR, color = group)) +
    geom_point(alpha = 0.7) +
    theme_minimal() +
    labs(title = "PC1 vs CDR", 
         x = paste0("PC1 (", pc1_var, "%)"),
         color = "Group") +
    scale_color_manual(values = group_colors)
  
  # PC2 vs CDR
  p3 <- ggplot(pca_df, aes(x = PC2, y = CDR, color = cell_type)) +
    geom_point(alpha = 0.7) +
    theme_minimal() +
    labs(title = "PC2 vs CDR", 
         x = paste0("PC2 (", pc2_var, "%)"),
         color = "Cell Type") +
    scale_color_manual(values = cell_type_colors)
  
  p4 <- ggplot(pca_df, aes(x = PC2, y = CDR, color = group)) +
    geom_point(alpha = 0.7) +
    theme_minimal() +
    labs(title = "PC2 vs CDR", 
         x = paste0("PC2 (", pc2_var, "%)"),
         color = "Group") +
    scale_color_manual(values = group_colors)
  
  # Combine all plots
  (p1 + p2) / (p3 + p4)
```

```{r}
ggplot(pca_df, aes(x = CDR, fill = group, color = group)) +
  geom_histogram(aes(y = after_stat(density)), alpha = 0.5, position = "identity", bins = 30) +
  geom_density(alpha = 0.7, fill = NA, adjust = 1) +
  theme_minimal() +
  labs(title = "CDR Distribution by Group",
       x = "Cellular Detection Rate",
       y = "Density") +
  scale_fill_manual(values = group_colors) +
  scale_color_manual(values = group_colors)
```

```{r}
# Randomly sample 20 genes
set.seed(77)
sampled_genes <- sample(rownames(expression_matrix), 20)
```
```{r}
# Create a data frame for all genes
plot_df <- data.frame(
  expression = numeric(),
  group = character(),
  gene = character()
)

# Combine data for all genes
for(gene in sampled_genes) {
  gene_expr <- expression_matrix[gene, ]
  gene_df <- data.frame(
    expression = gene_expr,
    group = metadata$group,
    gene = gene
  )
  plot_df <- rbind(plot_df, gene_df)
}

# Create faceted plot
ggplot(plot_df, aes(x = expression, fill = group, color = group)) +
  geom_histogram(aes(y = after_stat(density)), alpha = 0.5, position = "identity", bins = 30) +
  geom_density(alpha = 0.7, fill = NA) +
  facet_wrap(~gene, ncol = 4, scales = "free_y") +
  theme_minimal() +
  labs(x = "Expression",
       y = "Density") +
  scale_fill_manual(values = group_colors) +
  scale_color_manual(values = group_colors) +
  theme(strip.text = element_text(size = 8),
        axis.text = element_text(size = 6))
```

```{r}
# Create a data frame for all genes with sample information
plot_df_samples <- data.frame(
  expression = numeric(),
  sample = character(),
  gene = character()
)

# Combine data for all genes
for(gene in sampled_genes) {
  gene_expr <- expression_matrix[gene, ]
  gene_df <- data.frame(
    expression = gene_expr,
    sample = metadata$sample,
    gene = gene
  )
  plot_df_samples <- rbind(plot_df_samples, gene_df)
}

# Create faceted plot for samples
ggplot(plot_df_samples, aes(x = expression, color = sample)) +
  geom_density(alpha = 0.7) +
  facet_wrap(~gene, ncol = 4, scales = "free_y") +
  theme_minimal() +
  labs(x = "Expression",
       y = "Density") +
  scale_color_manual(values = sample_colors) +
  theme(strip.text = element_text(size = 8),
        axis.text = element_text(size = 6))
```

```{r}
# Create a data frame for all genes with cell type information
plot_df_celltypes <- data.frame(
  expression = numeric(),
  cell_type = character(),
  gene = character()
)

# Combine data for all genes
for(gene in sampled_genes) {
  gene_expr <- expression_matrix[gene, ]
  gene_df <- data.frame(
    expression = gene_expr,
    cell_type = metadata$cell_type,
    gene = gene
  )
  plot_df_celltypes <- rbind(plot_df_celltypes, gene_df)
}

# Create faceted plot for cell types
ggplot(plot_df_celltypes, aes(x = expression, fill = cell_type, color = cell_type)) +
  geom_histogram(aes(y = after_stat(density)), alpha = 0.5, position = "identity", bins = 30) +
  geom_density(alpha = 0.7, fill = NA) +
  facet_wrap(~gene, ncol = 4, scales = "free_y") +
  theme_minimal() +
  labs(x = "Expression",
       y = "Density") +
  scale_fill_manual(values = cell_type_colors) +
  scale_color_manual(values = cell_type_colors) +
  theme(strip.text = element_text(size = 8),
        axis.text = element_text(size = 6))
```

```{r}
# Create a data frame for all genes with cell type-group combination
plot_df_ct_grp <- data.frame(
  expression = numeric(),
  cell_type = character(),
  group = character(),
  gene = character()
)

# Combine data for all genes
for(gene in sampled_genes) {
  gene_expr <- expression_matrix[gene, ]
  gene_df <- data.frame(
    expression = gene_expr,
    cell_type = metadata$cell_type,
    group = metadata$group,
    gene = gene
  )
  plot_df_ct_grp <- rbind(plot_df_ct_grp, gene_df)
}

# Create cell type-group combination variable and colors
plot_df_ct_grp$ct_grp <- paste(plot_df_ct_grp$cell_type, plot_df_ct_grp$group, sep = "_")

# Define colors: distinct for cell types, similar within each cell type for groups
ct_grp_colors <- c(
  # CT1 - green shades
  "CT1_grp1" = "#1b9e77",  # darker green
  "CT1_grp2" = "#7fcdcd",  # lighter green
  # CT2 - orange shades  
  "CT2_grp1" = "#d95f02",  # darker orange
  "CT2_grp2" = "#ff9f59",  # lighter orange
  # CT3 - purple shades
  "CT3_grp1" = "#7570b3",  # darker purple
  "CT3_grp2" = "#c2a5f5"   # lighter purple
)

# Create faceted density plot for cell type-group combinations
ggplot(plot_df_ct_grp, aes(x = expression, color = ct_grp)) +
  geom_density(alpha = 0.8) +
  facet_wrap(~gene, ncol = 4, scales = "free_y") +
  theme_minimal() +
  labs(x = "Expression",
       y = "Density",
       title = "Gene Expression Density by Cell Type-Group Combinations") +
  scale_color_manual(values = ct_grp_colors,
                     name = "Cell Type - Group",
                     labels = c("CT1_grp1" = "CT1 - Group 1",
                               "CT1_grp2" = "CT1 - Group 2", 
                               "CT2_grp1" = "CT2 - Group 1",
                               "CT2_grp2" = "CT2 - Group 2",
                               "CT3_grp1" = "CT3 - Group 1", 
                               "CT3_grp2" = "CT3 - Group 2")) +
  theme(strip.text = element_text(size = 8),
        axis.text = element_text(size = 6),
        legend.position = "bottom") +
  guides(color = guide_legend(nrow = 2))
```

## Single Gene Expression Distribution Visualization

```{r single_gene_visualization}
# Function to visualize gene expression distribution across two groups
# Specify the gene of interest here
gene_of_interest <- "G434"  # Change this to any gene you want to visualize

# Check if gene exists in the data
if (!gene_of_interest %in% rownames(expression_matrix)) {
  stop(paste("Gene", gene_of_interest, "not found in expression matrix"))
}
if (!gene_of_interest %in% rownames(data.sim1$counts)) {
  stop(paste("Gene", gene_of_interest, "not found in count matrix"))
}

# Plot 1: Using log-normalized expression_matrix
expr_data <- data.frame(
  expression = expression_matrix[gene_of_interest, ],
  group = metadata$group,
  cell_id = colnames(expression_matrix)
)

p_expr <- ggplot(expr_data, aes(x = expression, fill = group, color = group)) +
  geom_histogram(aes(y = after_stat(density)), alpha = 0.5, position = "identity", bins = 30) +
  geom_density(alpha = 0.7, fill = NA, linewidth = 1) +
  theme_minimal() +
  labs(title = paste("Log-normalized Expression Distribution:", gene_of_interest),
       x = "Log-normalized Expression",
       y = "Density") +
  scale_fill_manual(values = group_colors) +
  scale_color_manual(values = group_colors) +
  theme(legend.position = "bottom")

# Plot 2: Using raw counts from data.sim1$counts
count_data <- data.frame(
  counts = data.sim1$counts[gene_of_interest, ],
  group = metadata$group,
  cell_id = colnames(data.sim1$counts)
)

p_counts <- ggplot(count_data, aes(x = counts, fill = group, color = group)) +
  geom_histogram(aes(y = after_stat(density)), alpha = 0.5, position = "identity", bins = 30) +
  geom_density(alpha = 0.7, fill = NA, linewidth = 1) +
  theme_minimal() +
  labs(title = paste("Raw Count Distribution:", gene_of_interest),
       x = "Raw Counts",
       y = "Density") +
  scale_fill_manual(values = group_colors) +
  scale_color_manual(values = group_colors) +
  theme(legend.position = "bottom")

# Combine the plots and explicitly print
combined_plot <- p_expr | p_counts
print(combined_plot)
```

## Differential Cell-Cell Communication Analysis with `ccc` Package

```{r}
ligands <- paste0("G", 1:500)
receptors <- paste0("G", 501:1000)
lrdb <- sim_lr(seed = 200, genes.l = ligands, genes.r = receptors, n_lr = 20)
```
```{r, eval = FALSE}
a <- ccc_diff(expression_matrix = expression_matrix, metadata = metadata,
              id_col = "sample", lr = lrdb, sender = "CT1", receiver = "CT2",
              lmm_re = TRUE, logmm_re = TRUE, marginal_cores = 2L)
```
```{r save results, eval = FALSE, echo = FALSE}
saveRDS(a, file = "./diff_a.rds")
```
```{r load results, echo = FALSE}
a <- readRDS("./diff_a.rds")
```
```{r}
a.res <- ccc_test(ccc_obj = a, contrast = c(grp1 = -1, grp2 = 1))
```

```{r, fig.heght = 12}
# Now create the plot with the correct structure
# Reshape the summary data for plotting
summary_long <- a$summary %>%
  # Create ligand-receptor pair labels
  mutate(pair = paste(ligand, receptor, sep = "-")) %>%
  # Select and rename columns for plotting
  select(pair, group,
         ligand.mean, ligand.mean_se,
         ligand.positive_mean, ligand.positive_mean_se,
         ligand.expression_rate, ligand.expression_rate_se,
         receptor.mean, receptor.mean_se,
         receptor.positive_mean, receptor.positive_mean_se,
         receptor.expression_rate, receptor.expression_rate_se) %>%
  # Reshape to long format for means and SEs
  pivot_longer(
    cols = c(ligand.positive_mean, ligand.expression_rate, ligand.mean,
             receptor.positive_mean, receptor.expression_rate, receptor.mean),
    names_to = "metric",
    values_to = "mean"
  ) %>%
  # Add corresponding SEs
  mutate(se = case_when(
    metric == "ligand.positive_mean" ~ ligand.positive_mean_se,
    metric == "ligand.expression_rate" ~ ligand.expression_rate_se,
    metric == "ligand.mean" ~ ligand.mean_se,
    metric == "receptor.positive_mean" ~ receptor.positive_mean_se,
    metric == "receptor.expression_rate" ~ receptor.expression_rate_se,
    metric == "receptor.mean" ~ receptor.mean_se
  )) %>%
  # Clean up metric names and convert to factor with specific order
  mutate(metric = case_when(
    metric == "ligand.positive_mean" ~ "ligand.positive",
    metric == "ligand.expression_rate" ~ "ligand.expression_rate",
    metric == "ligand.mean" ~ "ligand",
    metric == "receptor.positive_mean" ~ "receptor.positive",
    metric == "receptor.expression_rate" ~ "receptor.expression_rate",
    metric == "receptor.mean" ~ "receptor"
  )) %>%
  # Convert metric to factor with specific levels
  mutate(metric = factor(metric, 
    levels = c(
      "ligand.positive", "ligand.expression_rate", "ligand",
      "receptor.positive", "receptor.expression_rate", "receptor"
    )
  ))

# Create the plot
ggplot(summary_long, aes(x = group, y = mean, color = metric, group = metric)) +
  geom_pointrange(
    aes(ymin = mean - 1.96 * se, ymax = mean + 1.96 * se),
    position = position_dodge(width = 0.5),
    size = 0.1, shape = 1
  ) +
  facet_wrap(~pair, ncol = 4) +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 8),
    legend.position = "bottom",
    legend.title = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  labs(
    x = "Group",
    y = "Value",
    title = "Summary Statistics for Each Ligand-Receptor Pair"
  ) +
  scale_color_manual(
    values = c(
      # Ligand metrics in shades of blue
      "ligand.positive" = "#1f77b4",
      "ligand.expression_rate" = "#4c9ed9",
      "ligand" = "#7cb5e8",
      # Receptor metrics in shades of red
      "receptor.positive" = "#d62728",
      "receptor.expression_rate" = "#e57373",
      "receptor" = "#ffb6c1"
    ),
    labels = c(
      "ligand.positive" = "Ligand Positive Mean",
      "ligand.expression_rate" = "Ligand Expression Rate",
      "ligand" = "Ligand Mean",
      "receptor.positive" = "Receptor Positive Mean",
      "receptor.expression_rate" = "Receptor Expression Rate",
      "receptor" = "Receptor Mean"
    )
  ) +
  guides(color = guide_legend(nrow = 2, byrow = TRUE))
```

```{r}
# Create effect size plot using a.res
effect_size_data <- a.res %>%
  # Create ligand-receptor pair labels
  mutate(lr_pair = paste(ligand, receptor, sep = "-")) %>%
  # Select effect size and standard error columns
  select(lr_pair, 
         starts_with("effect_size_"), 
         starts_with("std_err_")) %>%
  # Reshape to long format for effect sizes
  pivot_longer(
    cols = starts_with("effect_size_"),
    names_to = "effect_type",
    values_to = "effect_size"
  ) %>%
  # Extract the model type (linear, logistic, hurdle) and contrast number
  mutate(
    model_type = case_when(
      grepl("linear", effect_type) ~ "linear",
      grepl("logistic", effect_type) ~ "logistic", 
      grepl("hurdle", effect_type) ~ "hurdle"
    ),
    contrast_num = gsub(".*_([0-9]+)$", "\\1", effect_type)
  ) %>%
  # Add corresponding standard errors
  mutate(
    std_err_col = paste0("std_err_", model_type, "_", contrast_num),
    std_err = case_when(
      model_type == "linear" ~ std_err_linear_1,
      model_type == "logistic" ~ std_err_logistic_1,
      model_type == "hurdle" ~ std_err_hurdle_1
    )
  ) %>%
  # Remove rows with missing values
  filter(!is.na(effect_size) & !is.na(std_err)) %>%
  # Calculate confidence intervals
  mutate(
    ci_lower = effect_size - 1.96 * std_err,
    ci_upper = effect_size + 1.96 * std_err,
    # Set factor levels to control facet order
    model_type = factor(model_type, levels = c("linear", "logistic", "hurdle"))
  )

# Create the plot
ggplot(effect_size_data, aes(x = lr_pair, y = effect_size, color = model_type)) +
  geom_pointrange(
    aes(ymin = ci_lower, ymax = ci_upper),
    position = position_dodge(width = 0.6),
    size = 0.5
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50", alpha = 0.7) +
  facet_wrap(~model_type, ncol = 1, scales = "free_y") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    strip.text = element_text(size = 10),
    legend.position = "none",  # Remove legend since we're faceting by model type
    panel.grid.minor = element_blank()
  ) +
  labs(
    x = "Ligand-Receptor Pair",
    y = "Effect Size ± 1.96*SE", 
    title = "Effect Sizes with 95% Confidence Intervals"
  ) +
  scale_color_manual(values = c(
    "linear" = "#1f77b4",
    "logistic" = "#ff7f0e", 
    "hurdle" = "#2ca02c"
  ))
```

```{r, warning = FALSE, fig.height = 8}
# Create a data frame for plotting
plot_data <- a.res %>%
  # Create ligand-receptor labels
  mutate(lr_pair = paste(ligand, receptor, sep = "-")) %>%
  # Select relevant columns and pivot to long format
  select(lr_pair, starts_with("pvalue_")) %>%
  pivot_longer(cols = starts_with("pvalue_"),
               names_to = "p_type",
               values_to = "p_value") %>%
  # Calculate -log10(p-value)
  mutate(neg_log10_p = -log10(p_value)) %>%
  # Convert p_type to factor to maintain original column order
  mutate(p_type = factor(p_type, levels = names(select(a.res, starts_with("pvalue_")))))

# Create the plot
ggplot(plot_data, aes(x = lr_pair, y = neg_log10_p)) +
  geom_bar(stat = "identity") +
  facet_wrap(~p_type, ncol = 1, scales = "fixed") +
  theme_minimal() +
  theme(
    #plot.margin = margin(b = 10, r = 60),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    strip.text = element_text(size = 10),
    panel.grid.major.x = element_line(color = "gray90"),  # Add vertical grid lines
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(color = "gray90"),  # Keep horizontal grid lines
    panel.grid.minor.y = element_blank()
  ) +
  labs(
    x = "Ligand-Receptor Pair",
    y = "-log10(p-value)"
  )
```

### Impact of random effects

```{r}
a_noRE <- ccc_diff(expression_matrix = expression_matrix, metadata = metadata,
              id_col = NULL, lr = lrdb, sender = "CT1", receiver = "CT2",
              lmm_re = FALSE, logmm_re = FALSE, marginal_cores = 2L
              )
```
```{r}
a_noRE.res <- ccc_test(ccc_obj = a_noRE, contrast = c(grp1 = -1, grp2 = 1))
```

```{r}
# Combine p-values from different models
pvalue_df <- data.frame(
  ligand = a.res$ligand,
  receptor = a.res$receptor,
  base_linear = a.res$pvalue_linear,
  base_logistic = a.res$pvalue_logistic,
  base_hurdle = a.res$pvalue_hurdle,
  base_2part = a.res$pvalue_2part,
  base_stouffer = a.res$pvalue_stouffer,
  base_fisher = a.res$pvalue_fisher,
  noRE_linear = a_noRE.res$pvalue_linear,
  noRE_logistic = a_noRE.res$pvalue_logistic,
  noRE_hurdle = a_noRE.res$pvalue_hurdle,
  noRE_2part = a_noRE.res$pvalue_2part,
  noRE_stouffer = a_noRE.res$pvalue_stouffer,
  noRE_fisher = a_noRE.res$pvalue_fisher
) %>%
  # Create ligand-receptor pair labels
  mutate(pair = paste(ligand, receptor, sep = "-"))

# Reshape data for plotting
pvalue_long <- pvalue_df %>%
  pivot_longer(
    cols = -c(ligand, receptor, pair),
    names_to = c("model", "test"),
    names_sep = "_",
    values_to = "pvalue"
  )
```

```{r, warning = FALSE, fig.height = 8}
# Create faceted line plot
pvalue_long$test <- factor(pvalue_long$test, 
                          levels = c("linear", "logistic", "hurdle", "2part", "stouffer", "fisher"))

ggplot(pvalue_long, aes(x = pair, y = -log10(pvalue), color = model, group = model)) +
  geom_line(alpha = 0.5) +
  geom_point(size = 2) +
  facet_wrap(~test, ncol = 1) +
  theme_minimal() +
  guides(color = guide_legend(nrow = 1)) +
  theme(
    #plot.margin = margin(b = 10, r = 60),
    strip.text = element_text(size = 10),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    legend.position = "bottom",
    legend.box = "horizontal",
    legend.key.spacing.x = unit(1, "cm")
  ) +
  labs(
    x = "Ligand-Receptor Pair",
    y = "-log10(p-value)",
    title = "Comparison of P-values Across Different Models and Tests",
    color = "Model"
  ) +
  scale_color_manual(values = c("base" = "#E41A1C", "noRE" = "#377EB8"),
                     labels = c("base" = "mixed effects models", "noRE" = "fixed effects models")) +
  # Add a horizontal line at p=0.05 (-log10(0.05) ≈ 1.3)
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "gray50")
```

### Impact of cellular detection rate (CDR) adjustment

```{r}
a_nocdr <- ccc_diff(expression_matrix = expression_matrix, metadata = metadata,
              id_col = "sample", lr = lrdb, sender = "CT1", receiver = "CT2",
              lmm_re = TRUE, logmm_re = TRUE, marginal_cores = 2L, cdr = FALSE
              )
```
```{r save results, eval = FALSE, echo = FALSE}
saveRDS(a_nocdr, file = "./diff_a_nocdr.rds")
```
```{r load results, echo = FALSE}
a_nocdr <- readRDS("./diff_a_nocdr.rds")
```
```{r}
a_nocdr.res <- ccc_test(ccc_obj = a_nocdr, contrast = c(grp1 = -1, grp2 = 1))
```

```{r, warning = FALSE}
# Combine p-values from different models
pvalue_df <- data.frame(
  ligand = a.res$ligand,
  receptor = a.res$receptor,
  with_linear = a.res$pvalue_linear,
  with_logistic = a.res$pvalue_logistic,
  with_hurdle = a.res$pvalue_hurdle,
  with_2part = a.res$pvalue_2part,
  with_stouffer = a.res$pvalue_stouffer,
  with_fisher = a.res$pvalue_fisher,
  no_linear = a_nocdr.res$pvalue_linear,
  no_logistic = a_nocdr.res$pvalue_logistic,
  no_hurdle = a_nocdr.res$pvalue_hurdle,
  no_2part = a_nocdr.res$pvalue_2part,
  no_stouffer = a_nocdr.res$pvalue_stouffer,
  no_fisher = a_nocdr.res$pvalue_fisher
) %>%
  # Create ligand-receptor pair labels
  mutate(pair = paste(ligand, receptor, sep = "-"))

# Reshape data for plotting
pvalue_long <- pvalue_df %>%
  pivot_longer(
    cols = -c(ligand, receptor, pair),
    names_to = c("model", "test"),
    names_sep = "_",
    values_to = "pvalue"
  ) %>%
  pivot_wider(
    names_from = model,
    values_from = pvalue
  )

# Set the order of test types
pvalue_long$test <- factor(pvalue_long$test, 
                          levels = c("linear", "logistic", "hurdle", "2part", "stouffer", "fisher"))

# Calculate correlation for each test type
cor_data <- pvalue_long %>%
  group_by(test) %>%
  summarise(
    cor = cor(-log10(with), -log10(no), method = "pearson", use = "na.or.complete")
  )

# Create faceted scatter plots with correlation
ggplot(pvalue_long, aes(x = -log10(with), y = -log10(no))) +
  geom_point(alpha = 0.6) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "gray50") +
  facet_wrap(~test, ncol = 2) +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 10),
    panel.grid.minor = element_blank()
  ) +
  labs(
    x = "With CDR (-log10 p-value)",
    y = "Without CDR (-log10 p-value)",
    title = "Comparison of P-values With and Without CDR Adjustment"
  ) +
  # Add correlation coefficient to each facet
  geom_text(
    data = cor_data,
    aes(x = 0, y = Inf, label = sprintf("r = %.3f", cor)),
    hjust = 0,
    vjust = 1.5,
    size = 3
  )
```

### Both ligand and receptor are non-DE genes

```{r}
# simulate binary ligand-receptor pairs using non-DE genes
nonDEG <- gene_info %>% 
  filter(grp2_logfc == 0) %>%
  pull(gene_id)
set.seed(77)
ligands <- sample(nonDEG, 100)
receptors <- sample(setdiff(nonDEG, ligands), 100)
lrdb.nonDEG <- sim_lr(seed = 200, genes.l = ligands, genes.r = receptors, dimer = 0, trimer = 0, n_lr = 20)
```
```{r, eval = FALSE}
a_nonDEG_s <- ccc_diff(expression_matrix = expression_matrix, metadata = metadata,
              id_col = "sample", lr = lrdb.nonDEG, 
              sender = "CT1", receiver = "CT2", marginal_cores = 2L, sandwich = TRUE)
```
```{r save results, eval = FALSE, echo = FALSE}
saveRDS(a_nonDEG, file = "./diff_a_noneDEG.rds")
```
```{r load results, echo = FALSE}
a_nonDEG <- readRDS("./diff_a_noneDEG.rds")
```
```{r}
a_nonDEG_s.res <- ccc_test(ccc_obj = a_nonDEG_s, contrast = c(grp1 = -1, grp2 = 1))
a_nonDEG.res <- ccc_test(ccc_obj = a_nonDEG, contrast = c(grp1 = -1, grp2 = 1))
```

```{r}

```
# Enrichment Analysis









